[uwsgi]
# Accept only valid configuration options
strict = true

# Process management info
master = true
single-interpreter = true
need-app = true
auto-procname = true
procname-prefix = driftbase-
die-on-term = true
master-fifo = /tmp/uwsgi-fifo
vacuum = true
uid = uwsgi
pidfile = /tmp/uwsgi.pid

# Threading management info
enable-threads = true
threads = without
gevent = 1000
workers = 4

# Application infos
module = driftbase.flask.driftbaseapp:app

http-socket = :8080
stats = 127.0.0.1:9191
listen = 128

ignore-sigpipe = true            #
ignore-write-errors = true       # stop error spam when socket is disconnected
disable-write-exception = true   #

logger = default stdio
logger = applogger stdio

# format uWSGI host logs as JSON
log-route = default ^((?!\{).)*$
log-encoder = json:default {"@timestamp":"${micros}", "levelname":"INFO", "name":"uwsgi", "message":"${msg}"}

# pass application logs through as is, as they are JSON already
log-route = applogger {
log-encoder = format:applogger ${msg}

# append a newline to all logs or they won't show
log-encoder = nl

# format request logs as JSON
log-format = {"@timestamp":"%(ltime)", "levelname":"INFO", "name":"uwsgi", "method":"%(method)", "uri":"%(uri)", "status":%(status), "remote_addr":"%(addr)", "request_size":%(cl), "response_time_ms":%(msecs), "response_size":%(size), "message": "%(method) %(uri)"}
